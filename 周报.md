# ItemBasedCF设计文档

## 1. 公式

实现的热点用户打压的余弦相似度协同过滤算法公式：

<img src="http://www.forkosh.com/mathtex.cgi? \Large $$sim(I_i,I_j)=\frac{\sum_{u\in\left( {U_{I_i}}\cap{U_{I_j}}\right)}\frac{1}{W_u}}{\sqrt{\sum_{v\in{U_{I_i}}}\frac{1}{W_v}\sum_{w\in{U_{I_j}}}\frac{1}{W_w}}}$$
">

其中

<img src="http://www.forkosh.com/mathtex.cgi? \Large $${W_u}=\frac{1}{\log(1+\left|{u}\right|)}$$
">

## 2. 函数接口

IBCF类中主要包含以下接口：

  - public IBCF setMaxBehaviorTimes(int s)
  - public IBCF setMaxCandidateSize(int s)
  - public DataFrame run(JavaSparkContext ctx,SQLContext sqlcontext,DataFrame inputDF)

### 2.1. setMaxBehaviorTimes

用于设定用户行为次数阈值，当用户行为（比如浏览）次数大于该阈值时，则在协同过滤算法运行前剔除该用户的行为记录。一般设为800以下，否则容易导致程序运行时间过长。

### 2.2. setMaxCandidateSize

用于控制输出候选集的大小。即设定了对每个item所给出的对应的itemList的最大长度，算法根据item与item之间的相似度降序排列itemList，然后取最大长度以内的itemList输出。

### 2.3. run

协同过滤算法的主程序。

>输入：

    inputDF：包括两列
    第一列是user:string
    第二列是item:string

>输出：

    outputDF：同样是两列
    第一列是item:string
    第二列是对应的候选集itemList:string
    其中itemList结构为“item1:score1;item2:score2;......”
    score是候选集中相应item与第一列的item之间的相似度。

## 3. 示例

在java程序中的调用示例如下：

```java
//处理数据，生成<user,item>对的数据集，并以IBCF_input的javabean类对象格式存放，方便后面转换为dataFrame格式
JavaRDD<IBCF_input> input = lines.map(new Function<String, IBCF_input>() {
    @Override
    public IBCF_input call(String s) {
        String[] b = s.split(",");
        return new IBCF_input().setUser(b[0]).setItem(b[1]);
    }
});

//创建输入的DataFrame，<user,item>两个字段
DataFrame inputDF = sqlcontext.createDataFrame(input, IBCF_input.class);
IBCF ibcf = new IBCF()
        .setMaxBehaviorTimes(maxBehaviorTimes)
        .setMaxCandidateSize(maxCandidateSize);
DataFrame outputDF=ibcf.run(ctx,sqlcontext,inputDF);
outputDF.show();
```

也可以通过调用jar包来实现该算法：
```sh
./bin/spark-submit \
--class "IBCF.IBCF_test" \
--master yarn --executor-memory 20G \
--total-executor-cores 48 \
/home/IBCF-1.0.0.jar \
/tmp/prm_user1 1 100 50
```
>注：调用jar包应该给出4个参数：输入数据文件名、行为类型、输入数据中用户最多行为次数、输出数据中候选集最多元素个数
